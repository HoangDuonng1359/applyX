<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbox AI - ApplyX</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: #334155;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .app-name {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .sidebar-section {
            padding: 16px 0;
        }

        .section-title {
            padding: 0 20px 8px;
            font-size: 12px;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #64748b;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .menu-item:hover {
            background-color: #f1f5f9;
            color: #334155;
        }

        .menu-item.active {
            background-color: #eff6ff;
            color: #2563eb;
            border-right: 3px solid #2563eb;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 20px 32px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }

        .main-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .main-subtitle {
            font-size: 14px;
            color: #64748b;
            font-weight: 400;
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            background: #f8fafc;
        }

        .message {
            display: flex;
            gap: 16px;
            max-width: 800px;
            animation: slideIn 0.4s ease-out;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
            max-width: 600px;
        }

        .message.bot {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }

        .message-content {
            background: white;
            padding: 16px 20px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
        }

        .typing-indicator {
            display: none;
            gap: 16px;
            max-width: 800px;
            align-self: flex-start;
        }

        .typing-content {
            background: white;
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .typing-text {
            font-size: 14px;
            color: #64748b;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #3b82f6;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        /* Chat Input */
        .chat-input-area {
            background: white;
            border-top: 1px solid #e2e8f0;
            padding: 24px 32px;
        }

        .quick-suggestions {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .suggestion-chip {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #475569;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-weight: 500;
        }

        .suggestion-chip:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            transform: translateY(-1px);
        }

        .chat-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 16px 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            outline: none;
            font-size: 14px;
            transition: all 0.2s;
            background: #f8fafc;
            font-family: inherit;
        }

        .input-field:focus {
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-field:disabled {
            background-color: #f1f5f9;
            cursor: not-allowed;
            color: #94a3b8;
        }

        .send-button {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 48px 32px;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 24px;
        }

        .welcome-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
        }

        .welcome-text {
            font-size: 14px;
            color: #64748b;
            line-height: 1.6;
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                overflow: hidden;
            }
            
            .main-header {
                padding: 16px 20px;
            }
            
            .chat-messages {
                padding: 20px;
            }
            
            .chat-input-area {
                padding: 16px 20px;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-logo">A</div>
                <span class="app-name">ApplyX</span>
            </div>
            
            <div class="sidebar-section">
                <div class="section-title">Hành trình của bạn</div>
                <div class="menu-item">
                    <div class="menu-icon">🎯</div>
                    <span>Định hướng bản thân</span>
                </div>
                <div class="menu-item">
                    <div class="menu-icon">📊</div>
                    <span>Kết quả phân tích</span>
                </div>
                <div class="menu-item active">
                    <div class="menu-icon">🤖</div>
                    <span>Chatbox AI</span>
                </div>
                <div class="menu-item">
                    <div class="menu-icon">📁</div>
                    <span>Hồ sơ & Tài liệu</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="main-header">
                <h1 class="main-title">Chatbox AI</h1>
                <p class="main-subtitle">Trò chuyện với AI để được tư vấn và hỗ trợ về định hướng nghề nghiệp</p>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message" id="welcomeMessage">
                        <div class="welcome-icon">🤖</div>
                        <h2 class="welcome-title">Chào mừng đến với Chatbox AI!</h2>
                        <p class="welcome-text">
                            Tôi là trợ lý AI của bạn, sẵn sàng hỗ trợ về tư vấn tuyển sinh, định hướng nghề nghiệp, 
                            và trả lời mọi thắc mắc của bạn. Hãy bắt đầu cuộc trò chuyện bằng cách chọn một gợi ý 
                            bên dưới hoặc nhập câu hỏi của bạn.
                        </p>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar">🤖</div>
                    <div class="typing-content">
                        <span class="typing-text">AI đang suy nghĩ</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="chat-input-area">
                    <div class="quick-suggestions">
                        <div class="suggestion-chip" onclick="sendSuggestion('Các ngành học phù hợp với tôi?')">Ngành học phù hợp</div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Điểm chuẩn các trường đại học?')">Điểm chuẩn</div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Học phí các trường như thế nào?')">Học phí</div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Thời gian đăng ký xét tuyển?')">Thời gian đăng ký</div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Tư vấn định hướng nghề nghiệp')">Định hướng nghề nghiệp</div>
                    </div>
                    
                    <div class="chat-input">
                        <input 
                            type="text" 
                            class="input-field" 
                            id="messageInput" 
                            placeholder="Đang kết nối với AI..."
                            maxlength="500"
                            disabled
                        >
                        <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                            ➤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const welcomeMessage = document.getElementById('welcomeMessage');

        // ====================================================================
        // === CẤU HÌNH API - BẠN CẦN THAY ĐỔI URL NÀY                       ===
        // ====================================================================
        const BASE_API_URL = 'http://localhost:8000'; // <<<<<<< THAY BẰNG URL API CỦA BẠN
        // ====================================================================

        let sessionId = null;
        let isFirstMessage = true;

        // --- BƯỚC 1: TẠO SESSION KHI TẢI TRANG ---
        async function createSession() {
            try {
                const response = await fetch(`${BASE_API_URL}/chatbot/session`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Lỗi HTTP! Status: ${response.status}`);
                }

                const data = await response.json();
                sessionId = data.session_id;

                // Kích hoạt ô nhập liệu khi đã có session
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.placeholder = 'Nhập câu hỏi của bạn...';
                messageInput.focus();
                console.log('Session created:', sessionId);

            } catch (error) {
                console.error('Không thể tạo session:', error);
                hideWelcomeMessage();
                addMessage('Xin lỗi, không thể kết nối đến máy chủ. Vui lòng tải lại trang.', 'bot');
                messageInput.placeholder = 'Lỗi kết nối';
            }
        }
        
        // --- BƯỚC 2: GỬI TIN NHẮN ĐẾN API ---
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (message === '' || sendButton.disabled) return;

            // Kiểm tra xem đã có session chưa
            if (!sessionId) {
                hideWelcomeMessage();
                addMessage('Phiên trò chuyện chưa sẵn sàng, vui lòng đợi hoặc tải lại trang.', 'bot');
                return;
            }

            // Ẩn welcome message khi có tin nhắn đầu tiên
            if (isFirstMessage) {
                hideWelcomeMessage();
                isFirstMessage = false;
            }

            // Thêm tin nhắn của user vào giao diện
            addMessage(message, 'user');
            messageInput.value = '';
            
            // Vô hiệu hóa nút gửi và hiện chỉ báo đang gõ
            sendButton.disabled = true;
            showTyping();

            try {
                // Gọi API backend với session_id và message
                const response = await fetch(`${BASE_API_URL}/chatbot/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`Lỗi HTTP! Status: ${response.status}`);
                }
                
                // Theo API docs, response là một chuỗi text
                const data = await response.json();
                const botReply = data.response;
                
                // Ẩn chỉ báo đang gõ và hiện câu trả lời của bot
                hideTyping();
                addMessage(botReply, 'bot');

            } catch (error) {
                console.error('Lỗi khi gửi tin nhắn:', error);
                hideTyping();
                addMessage('Xin lỗi, đã có lỗi xảy ra trong quá trình xử lý. Vui lòng thử lại sau.', 'bot');
            } finally {
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        // --- CÁC HÀM TIỆN ÍCH ---

        // Hàm ẩn welcome message
        function hideWelcomeMessage() {
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
        }

        // Hàm thêm tin nhắn vào chat
        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = sender === 'bot' ? '🤖' : '👤';
            const formattedContent = marked.parse(content);

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${formattedContent}</div>
            `;

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Hàm gửi gợi ý nhanh
        function sendSuggestion(suggestion) {
            if (sendButton.disabled) return;
            messageInput.value = suggestion;
            sendMessage();
        }

        // Hiển thị typing indicator
        function showTyping() {
            typingIndicator.style.display = 'flex';
            scrollToBottom();
        }

        // Ẩn typing indicator
        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        // Scroll xuống cuối
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Event listeners
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // --- KHỞI CHẠY ---
        // Gọi hàm tạo session ngay khi script được tải
        document.addEventListener('DOMContentLoaded', createSession);
    </script>
</body>
</html>